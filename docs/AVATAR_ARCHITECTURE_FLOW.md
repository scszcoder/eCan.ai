# Avatar ç³»ç»Ÿæ¶æ„ä¸å·¥ä½œæµç¨‹

## ğŸ“ æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å‰ç«¯ (React/TypeScript)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ AvatarManagerâ”‚  â”‚AvatarSelectorâ”‚  â”‚AvatarUploaderâ”‚      â”‚
â”‚  â”‚  (ç®¡ç†ç»„ä»¶)   â”‚  â”‚  (é€‰æ‹©å™¨)     â”‚  â”‚  (ä¸Šä¼ å™¨)     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                  â”‚                  â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                            â”‚                                 â”‚
â”‚                            â”‚ IPC è°ƒç”¨                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    IPC å±‚ (è¿›ç¨‹é—´é€šä¿¡)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚           AvatarHandler (IPC Handler)            â”‚       â”‚
â”‚  â”‚  - avatar.get_system_avatars                     â”‚       â”‚
â”‚  â”‚  - avatar.upload_avatar                          â”‚       â”‚
â”‚  â”‚  - avatar.get_uploaded_avatars                   â”‚       â”‚
â”‚  â”‚  - avatar.set_agent_avatar                       â”‚       â”‚
â”‚  â”‚  - avatar.generate_avatar_video                  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                     â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åç«¯ (Python)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚          AvatarManager (æ ¸å¿ƒç®¡ç†å™¨)               â”‚       â”‚
â”‚  â”‚  - ç³»ç»Ÿå¤´åƒç®¡ç†                                   â”‚       â”‚
â”‚  â”‚  - å›¾ç‰‡éªŒè¯å’Œä¸Šä¼                                  â”‚       â”‚
â”‚  â”‚  - ç¼©ç•¥å›¾ç”Ÿæˆ                                     â”‚       â”‚
â”‚  â”‚  - æ–‡ä»¶ hash è®¡ç®—                                 â”‚       â”‚
â”‚  â”‚  - æœ¬åœ°å­˜å‚¨ç®¡ç†                                   â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                     â”‚                                        â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚         â–¼           â–¼           â–¼                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ DBAgent  â”‚ â”‚DBAvatarResâ”‚ â”‚æ–‡ä»¶ç³»ç»Ÿ  â”‚                    â”‚
â”‚  â”‚  Model   â”‚ â”‚  Model    â”‚ â”‚          â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‚ ç›®å½•ç»“æ„

```
eCan.ai/
â”œâ”€â”€ gui_v2/src/                          # å‰ç«¯ä»£ç 
â”‚   â”œâ”€â”€ assets/avatars/                  # âœ… ç³»ç»Ÿå¤´åƒèµ„æºï¼ˆæºæ–‡ä»¶ï¼‰
â”‚   â”‚   â”œâ”€â”€ A001.png                     # ä¸“ä¸šç”·æ€§
â”‚   â”‚   â”œâ”€â”€ A002.png                     # ä¸“ä¸šå¥³æ€§
â”‚   â”‚   â”œâ”€â”€ A003.png                     # ä¼‘é—²ç”·æ€§
â”‚   â”‚   â”œâ”€â”€ A004.png                     # ä¼‘é—²å¥³æ€§
â”‚   â”‚   â”œâ”€â”€ A005.png                     # ç§‘æŠ€ä¸“ä¸šäººå£«
â”‚   â”‚   â”œâ”€â”€ A006.png                     # åˆ›æ„ä¸“ä¸šäººå£«
â”‚   â”‚   â””â”€â”€ A007.png                     # é«˜ç®¡
â”‚   â”‚
â”‚   â”œâ”€â”€ components/Avatar/               # Avatar ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ index.ts                     # ç»„ä»¶å¯¼å‡º
â”‚   â”‚   â”œâ”€â”€ AvatarManager.tsx            # ç®¡ç†ç»„ä»¶ï¼ˆé›†æˆï¼‰
â”‚   â”‚   â”œâ”€â”€ AvatarSelector.tsx           # é€‰æ‹©å™¨ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ AvatarSelector.css
â”‚   â”‚   â”œâ”€â”€ AvatarUploader.tsx           # ä¸Šä¼ å™¨ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ AvatarUploader.css
â”‚   â”‚   â”œâ”€â”€ AvatarDisplay.tsx            # æ˜¾ç¤ºç»„ä»¶
â”‚   â”‚   â””â”€â”€ AvatarDisplay.css
â”‚   â”‚
â”‚   â”œâ”€â”€ pages/Agents/components/
â”‚   â”‚   â””â”€â”€ AgentDetails.tsx             # âœ… é›†æˆäº† AvatarManager
â”‚   â”‚
â”‚   â””â”€â”€ i18n/locales/
â”‚       â”œâ”€â”€ en-US.json                   # âœ… è‹±æ–‡ç¿»è¯‘
â”‚       â””â”€â”€ zh-CN.json                   # âœ… ä¸­æ–‡ç¿»è¯‘
â”‚
â”œâ”€â”€ agent/                               # åç«¯ä»£ç 
â”‚   â”œâ”€â”€ avatar/                          # Avatar æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ avatar_manager.py            # âœ… æ ¸å¿ƒç®¡ç†å™¨
â”‚   â”‚   â””â”€â”€ init_system_avatars.py       # åˆå§‹åŒ–è„šæœ¬
â”‚   â”‚
â”‚   â””â”€â”€ db/
â”‚       â”œâ”€â”€ models/
â”‚       â”‚   â”œâ”€â”€ agent_model.py           # âœ… æ‰©å±•äº† avatar å­—æ®µ
â”‚       â”‚   â””â”€â”€ avatar_model.py          # âœ… Avatar èµ„æºæ¨¡å‹
â”‚       â”‚
â”‚       â””â”€â”€ migrations/
â”‚           â”œâ”€â”€ migration_config.py      # âœ… æ›´æ–°åˆ° 3.0.5
â”‚           â”œâ”€â”€ migration_manager.py     # âœ… æ·»åŠ  3.0.5 æ˜ å°„
â”‚           â””â”€â”€ versions/
â”‚               â””â”€â”€ migration_304_to_305.py  # âœ… è¿ç§»è„šæœ¬
â”‚
â”œâ”€â”€ gui/ipc/w2p_handlers/
â”‚   â””â”€â”€ avatar_handler.py                # âœ… IPC Handler
â”‚
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ generate_placeholder_avatars.py  # å¤´åƒç”Ÿæˆå·¥å…·
â”‚
â””â”€â”€ {appdata_path}/avatars/              # è¿è¡Œæ—¶å¤´åƒç›®å½•
    â”œâ”€â”€ system/                          # ç³»ç»Ÿå¤´åƒï¼ˆè¿è¡Œæ—¶ï¼‰
    â”‚   â”œâ”€â”€ A001.png                     # ä» gui_v2/src/assets å¤åˆ¶
    â”‚   â”œâ”€â”€ A002.png
    â”‚   â””â”€â”€ ...
    â”œâ”€â”€ uploaded/                        # ç”¨æˆ·ä¸Šä¼ 
    â”‚   â”œâ”€â”€ {hash}_original.png
    â”‚   â”œâ”€â”€ {hash}_thumb.png
    â”‚   â””â”€â”€ ...
    â””â”€â”€ generated/                       # AI ç”Ÿæˆ
        â””â”€â”€ {hash}_video.mp4
```

---

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹

### 1. ç³»ç»Ÿåˆå§‹åŒ–æµç¨‹

```
å¯åŠ¨åº”ç”¨
    â”‚
    â”œâ”€> æ£€æŸ¥ {appdata_path}/avatars/system/ ç›®å½•
    â”‚   â”‚
    â”‚   â”œâ”€> å¦‚æœä¸å­˜åœ¨ â†’ è¿è¡Œ init_system_avatars.py
    â”‚   â”‚   â”‚
    â”‚   â”‚   â””â”€> ä» gui_v2/src/assets/avatars/ å¤åˆ¶åˆ°
    â”‚   â”‚       {appdata_path}/avatars/system/
    â”‚   â”‚
    â”‚   â””â”€> å¦‚æœå­˜åœ¨ â†’ è·³è¿‡åˆå§‹åŒ–
    â”‚
    â””â”€> åº”ç”¨å°±ç»ª
```

**å…³é”®ç‚¹**:
- âœ… æºæ–‡ä»¶åœ¨å‰ç«¯: `gui_v2/src/assets/avatars/`
- âœ… è¿è¡Œæ—¶åœ¨åç«¯: `{appdata_path}/avatars/system/`
- âœ… åˆå§‹åŒ–è„šæœ¬: `python3 -m agent.avatar.init_system_avatars`

### 2. åˆ›å»º Agent æµç¨‹

```
ç”¨æˆ·æ“ä½œ: åˆ›å»ºæ–° Agent
    â”‚
    â”œâ”€> æ‰“å¼€ AgentDetails é¡µé¢
    â”‚   â”‚
    â”‚   â””â”€> æ¸²æŸ“ AvatarManager ç»„ä»¶
    â”‚       â”‚
    â”‚       â”œâ”€> ç”¨æˆ·ç‚¹å‡»å¤´åƒ
    â”‚       â”‚   â”‚
    â”‚       â”‚   â””â”€> æ‰“å¼€ Modal æ˜¾ç¤º AvatarSelector
    â”‚       â”‚       â”‚
    â”‚       â”‚       â”œâ”€> Tab 1: ç³»ç»Ÿå¤´åƒ
    â”‚       â”‚       â”‚   â”‚
    â”‚       â”‚       â”‚   â”œâ”€> IPC è°ƒç”¨: avatar.get_system_avatars
    â”‚       â”‚       â”‚   â”‚   â”‚
    â”‚       â”‚       â”‚   â”‚   â””â”€> AvatarHandler.get_system_avatars()
    â”‚       â”‚       â”‚   â”‚       â”‚
    â”‚       â”‚       â”‚   â”‚       â””â”€> AvatarManager.get_system_avatars()
    â”‚       â”‚       â”‚   â”‚           â”‚
    â”‚       â”‚       â”‚   â”‚           â””â”€> è¯»å– {appdata_path}/avatars/system/
    â”‚       â”‚       â”‚   â”‚               â”‚
    â”‚       â”‚       â”‚   â”‚               â””â”€> è¿”å›å¤´åƒåˆ—è¡¨
    â”‚       â”‚       â”‚   â”‚
    â”‚       â”‚       â”‚   â””â”€> æ˜¾ç¤º 7 ä¸ªç³»ç»Ÿå¤´åƒ
    â”‚       â”‚       â”‚
    â”‚       â”‚       â””â”€> Tab 2: æˆ‘çš„å¤´åƒ
    â”‚       â”‚           â”‚
    â”‚       â”‚           â”œâ”€> IPC è°ƒç”¨: avatar.get_uploaded_avatars
    â”‚       â”‚           â”‚   â”‚
    â”‚       â”‚           â”‚   â””â”€> è¿”å›ç”¨æˆ·ä¸Šä¼ çš„å¤´åƒåˆ—è¡¨
    â”‚       â”‚           â”‚
    â”‚       â”‚           â””â”€> æ˜¾ç¤ºç”¨æˆ·å¤´åƒ
    â”‚       â”‚
    â”‚       â””â”€> ç”¨æˆ·é€‰æ‹©å¤´åƒ
    â”‚           â”‚
    â”‚           â””â”€> æ›´æ–° avatarData çŠ¶æ€
    â”‚
    â””â”€> ç”¨æˆ·ç‚¹å‡»ä¿å­˜
        â”‚
        â””â”€> æäº¤è¡¨å•
            â”‚
            â”œâ”€> åŒ…å« avatar æ•°æ®:
            â”‚   - avatar_type: 'system' | 'uploaded'
            â”‚   - avatar_image_url: '/avatars/system/A001.png'
            â”‚   - avatar_video_url: '/avatars/system/A001.mp4'
            â”‚   - avatar_metadata: { id, name, tags, hash }
            â”‚
            â””â”€> IPC è°ƒç”¨: newAgent / saveAgent
                â”‚
                â””â”€> ä¿å­˜åˆ°æ•°æ®åº“ (DBAgent è¡¨)
```

### 3. ä¸Šä¼ å¤´åƒæµç¨‹

```
ç”¨æˆ·æ“ä½œ: ä¸Šä¼ è‡ªå®šä¹‰å¤´åƒ
    â”‚
    â”œâ”€> åœ¨ AvatarSelector ä¸­ç‚¹å‡»"ä¸Šä¼ æ–°å¤´åƒ"
    â”‚   â”‚
    â”‚   â””â”€> AvatarUploader ç»„ä»¶
    â”‚       â”‚
    â”‚       â”œâ”€> ç”¨æˆ·é€‰æ‹©æ–‡ä»¶ï¼ˆç‚¹å‡»æˆ–æ‹–æ‹½ï¼‰
    â”‚       â”‚   â”‚
    â”‚       â”‚   â””â”€> å‰ç«¯éªŒè¯:
    â”‚       â”‚       - æ ¼å¼: PNG/JPG/GIF/WebP
    â”‚       â”‚       - å¤§å°: < 10MB
    â”‚       â”‚
    â”‚       â”œâ”€> è½¬æ¢ä¸º Base64
    â”‚       â”‚
    â”‚       â””â”€> IPC è°ƒç”¨: avatar.upload_avatar
    â”‚           â”‚
    â”‚           â””â”€> AvatarHandler.upload_avatar()
    â”‚               â”‚
    â”‚               â””â”€> AvatarManager.upload_avatar()
    â”‚                   â”‚
    â”‚                   â”œâ”€> éªŒè¯å›¾ç‰‡ï¼ˆæ ¼å¼ã€å¤§å°ã€å†…å®¹ï¼‰
    â”‚                   â”‚
    â”‚                   â”œâ”€> è®¡ç®— MD5 hash
    â”‚                   â”‚
    â”‚                   â”œâ”€> ä¿å­˜åŸå›¾:
    â”‚                   â”‚   {appdata_path}/avatars/uploaded/{hash}_original.png
    â”‚                   â”‚
    â”‚                   â”œâ”€> ç”Ÿæˆç¼©ç•¥å›¾:
    â”‚                   â”‚   {appdata_path}/avatars/uploaded/{hash}_thumb.png
    â”‚                   â”‚
    â”‚                   â”œâ”€> ä¿å­˜åˆ°æ•°æ®åº“ (DBAvatarResource è¡¨)
    â”‚                   â”‚
    â”‚                   â””â”€> è¿”å›å¤´åƒä¿¡æ¯
    â”‚
    â””â”€> ä¸Šä¼ æˆåŠŸ
        â”‚
        â””â”€> åˆ·æ–°"æˆ‘çš„å¤´åƒ"åˆ—è¡¨
```

### 4. ç¼–è¾‘ Agent æµç¨‹

```
ç”¨æˆ·æ“ä½œ: ç¼–è¾‘ç°æœ‰ Agent
    â”‚
    â”œâ”€> æ‰“å¼€ AgentDetails é¡µé¢
    â”‚   â”‚
    â”‚   â”œâ”€> IPC è°ƒç”¨: getAgents(id)
    â”‚   â”‚   â”‚
    â”‚   â”‚   â””â”€> è·å– Agent æ•°æ®ï¼ˆåŒ…å« avatar å­—æ®µï¼‰
    â”‚   â”‚
    â”‚   â”œâ”€> è®¾ç½®è¡¨å•å€¼
    â”‚   â”‚
    â”‚   â””â”€> è®¾ç½® avatarData çŠ¶æ€:
    â”‚       - type: agent.avatar_type
    â”‚       - imageUrl: agent.avatar_image_url
    â”‚       - videoUrl: agent.avatar_video_url
    â”‚       - metadata: agent.avatar_metadata
    â”‚
    â”œâ”€> AvatarManager æ˜¾ç¤ºå½“å‰å¤´åƒ
    â”‚
    â”œâ”€> ç”¨æˆ·å¯ä»¥æ›´æ¢å¤´åƒ
    â”‚
    â””â”€> ä¿å­˜æ—¶æ›´æ–° avatar æ•°æ®
```

---

## ğŸ’¾ æ•°æ®åº“ç»“æ„

### DBAgent è¡¨ï¼ˆæ‰©å±•å­—æ®µï¼‰

```sql
CREATE TABLE agents (
    -- åŸæœ‰å­—æ®µ...
    
    -- Avatar å­—æ®µï¼ˆæ–°å¢ï¼‰
    avatar_type VARCHAR(32) DEFAULT 'system',  -- system, uploaded, generated
    avatar_image_url VARCHAR(512),              -- å¤´åƒå›¾ç‰‡ URL
    avatar_video_url VARCHAR(512),              -- å¤´åƒè§†é¢‘ URL
    avatar_metadata TEXT                        -- JSON: {id, name, tags, hash}
);
```

### DBAvatarResource è¡¨ï¼ˆæ–°å»ºï¼‰

```sql
CREATE TABLE avatar_resources (
    id VARCHAR(64) PRIMARY KEY,                 -- avatar_{uuid}
    resource_type VARCHAR(32) NOT NULL,         -- system, uploaded, generated
    name VARCHAR(128),                          -- èµ„æºåç§°
    description VARCHAR(512),                   -- æè¿°
    
    -- æœ¬åœ°æ–‡ä»¶è·¯å¾„
    image_path VARCHAR(512),                    -- å›¾ç‰‡è·¯å¾„
    video_path VARCHAR(512),                    -- è§†é¢‘è·¯å¾„
    image_hash VARCHAR(64),                     -- å›¾ç‰‡ MD5
    video_hash VARCHAR(64),                     -- è§†é¢‘ MD5
    
    -- äº‘ç«¯å­˜å‚¨ï¼ˆé¢„ç•™ï¼‰
    cloud_image_url VARCHAR(512),               -- äº‘ç«¯å›¾ç‰‡ URL
    cloud_video_url VARCHAR(512),               -- äº‘ç«¯è§†é¢‘ URL
    cloud_image_key VARCHAR(512),               -- S3 key
    cloud_video_key VARCHAR(512),               -- S3 key
    cloud_synced INTEGER DEFAULT 0,             -- æ˜¯å¦å·²åŒæ­¥
    
    -- å…ƒæ•°æ®
    avatar_metadata TEXT,                       -- JSON å…ƒæ•°æ®
    
    -- ä½¿ç”¨ç»Ÿè®¡
    usage_count INTEGER DEFAULT 0,              -- ä½¿ç”¨æ¬¡æ•°
    last_used_at TIMESTAMP,                     -- æœ€åä½¿ç”¨æ—¶é—´
    
    -- æ‰€æœ‰è€…
    owner VARCHAR(128),                         -- æ‰€æœ‰è€…ç”¨æˆ·å
    is_public INTEGER DEFAULT 0,                -- æ˜¯å¦å…¬å¼€
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_avatar_resources_owner ON avatar_resources(owner);
CREATE INDEX idx_avatar_resources_type ON avatar_resources(resource_type);
CREATE INDEX idx_avatar_resources_hash ON avatar_resources(image_hash);
```

---

## ğŸ”Œ API æ¥å£

### å‰ç«¯ â†’ IPC â†’ åç«¯

#### 1. è·å–ç³»ç»Ÿå¤´åƒ
```typescript
// å‰ç«¯è°ƒç”¨
const response = await api.invoke('avatar.get_system_avatars', { username });

// è¿”å›
{
  success: true,
  data: [
    {
      id: "A001",
      name: "Professional Male",
      type: "system",
      imageUrl: "/avatars/system/A001.png",
      videoUrl: "/avatars/system/A001.mp4",
      imageExists: true,
      videoExists: false
    },
    ...
  ]
}
```

#### 2. ä¸Šä¼ å¤´åƒ
```typescript
// å‰ç«¯è°ƒç”¨
const response = await api.invoke('avatar.upload_avatar', {
  username,
  fileData: base64String,
  filename: 'avatar.png'
});

// è¿”å›
{
  success: true,
  data: {
    imageUrl: "/avatars/uploaded/abc123_original.png",
    thumbnailUrl: "/avatars/uploaded/abc123_thumb.png",
    hash: "abc123",
    metadata: { format: "png", size: 12345, dimensions: [512, 512] }
  }
}
```

#### 3. è·å–å·²ä¸Šä¼ å¤´åƒ
```typescript
// å‰ç«¯è°ƒç”¨
const response = await api.invoke('avatar.get_uploaded_avatars', { username });

// è¿”å›
{
  success: true,
  data: [
    {
      type: "uploaded",
      hash: "abc123",
      imageUrl: "/avatars/uploaded/abc123_original.png",
      thumbnailUrl: "/avatars/uploaded/abc123_thumb.png"
    },
    ...
  ]
}
```

#### 4. è®¾ç½® Agent å¤´åƒ
```typescript
// å‰ç«¯è°ƒç”¨ï¼ˆåœ¨ä¿å­˜ Agent æ—¶ï¼‰
const payload = {
  ...agentData,
  avatar_type: 'system',
  avatar_image_url: '/avatars/system/A001.png',
  avatar_video_url: '/avatars/system/A001.mp4',
  avatar_metadata: { id: 'A001', name: 'Professional Male' }
};

await api.saveAgent(username, [payload]);
```

---

## ğŸ”’ å®‰å…¨æœºåˆ¶

### 1. æ–‡ä»¶éªŒè¯
```python
# avatar_manager.py
def validate_image(file_data, filename):
    # æ£€æŸ¥æ–‡ä»¶å¤§å°
    if len(file_data) > MAX_IMAGE_SIZE:
        return error("æ–‡ä»¶è¿‡å¤§")
    
    # æ£€æŸ¥æ–‡ä»¶æ ¼å¼
    ext = filename.rsplit('.', 1)[-1].lower()
    if ext not in SUPPORTED_FORMATS:
        return error("ä¸æ”¯æŒçš„æ ¼å¼")
    
    # ä½¿ç”¨ PIL éªŒè¯å›¾ç‰‡å®Œæ•´æ€§
    try:
        image = Image.open(io.BytesIO(file_data))
        # éªŒè¯æˆåŠŸ
    except:
        return error("æ— æ•ˆçš„å›¾ç‰‡æ–‡ä»¶")
```

### 2. ç”¨æˆ·éš”ç¦»
- æ¯ä¸ªç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±ä¸Šä¼ çš„å¤´åƒ
- ç³»ç»Ÿå¤´åƒå¯¹æ‰€æœ‰ç”¨æˆ·å¯è§
- é€šè¿‡ `username` å‚æ•°éš”ç¦»

### 3. æ–‡ä»¶å»é‡
- ä½¿ç”¨ MD5 hash è¯†åˆ«ç›¸åŒæ–‡ä»¶
- é¿å…é‡å¤å­˜å‚¨

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. ç¼©ç•¥å›¾
- è‡ªåŠ¨ç”Ÿæˆ 256x256 ç¼©ç•¥å›¾
- åˆ—è¡¨æ˜¾ç¤ºä½¿ç”¨ç¼©ç•¥å›¾ï¼Œå‡å°‘åŠ è½½æ—¶é—´

### 2. æœ¬åœ°ç¼“å­˜
- ç³»ç»Ÿå¤´åƒåœ¨åˆå§‹åŒ–æ—¶å¤åˆ¶åˆ°æœ¬åœ°
- é¿å…æ¯æ¬¡éƒ½ä»æºç›®å½•è¯»å–

### 3. æ‡’åŠ è½½
- å‰ç«¯ç»„ä»¶æ”¯æŒæ‡’åŠ è½½
- åªåœ¨éœ€è¦æ—¶åŠ è½½å¤´åƒåˆ—è¡¨

---

## ğŸš€ æ‰©å±•ç‚¹

### 1. äº‘ç«¯åŒæ­¥ï¼ˆé¢„ç•™ï¼‰
```python
# æ¥å£å·²é¢„ç•™
class CloudAvatarStorage:
    def upload_to_s3(image_path, s3_key):
        pass
    
    def download_from_s3(s3_key, local_path):
        pass
```

### 2. AI è§†é¢‘ç”Ÿæˆï¼ˆé¢„ç•™ï¼‰
```python
# æ¥å£å·²é¢„ç•™
async def generate_avatar_video(image_path, model, params):
    # è°ƒç”¨ LLM API ç”Ÿæˆè§†é¢‘
    pass
```

### 3. CDN åŠ é€Ÿï¼ˆæ¶æ„æ”¯æŒï¼‰
- äº‘ç«¯ URL å¯ä»¥é…ç½®ä¸º CDN åœ°å€
- å‰ç«¯ç›´æ¥ä» CDN åŠ è½½

---

## âœ… å®Œæ•´æ€§æ£€æŸ¥

### æ•°æ®åº“
- [x] DBAgent æ¨¡å‹æ‰©å±•
- [x] DBAvatarResource æ¨¡å‹åˆ›å»º
- [x] è¿ç§»è„šæœ¬ (3.0.4 â†’ 3.0.5)
- [x] è¿ç§»é…ç½®æ›´æ–°

### åç«¯
- [x] AvatarManager æ ¸å¿ƒç®¡ç†å™¨
- [x] AvatarHandler IPC å¤„ç†å™¨
- [x] åˆå§‹åŒ–è„šæœ¬
- [x] æ–‡ä»¶éªŒè¯
- [x] ç¼©ç•¥å›¾ç”Ÿæˆ
- [x] Hash è®¡ç®—

### å‰ç«¯
- [x] AvatarManager ç»„ä»¶
- [x] AvatarSelector ç»„ä»¶
- [x] AvatarUploader ç»„ä»¶
- [x] AvatarDisplay ç»„ä»¶
- [x] AgentDetails é›†æˆ
- [x] å¤šè¯­è¨€ç¿»è¯‘

### èµ„æº
- [x] ç³»ç»Ÿå¤´åƒ (gui_v2/src/assets/avatars/)
- [x] åˆå§‹åŒ–è„šæœ¬
- [x] ç”Ÿæˆå·¥å…·

### æ–‡æ¡£
- [x] æ¶æ„è®¾è®¡
- [x] å®æ–½è®¡åˆ’
- [x] API æ–‡æ¡£
- [x] ä½¿ç”¨æŒ‡å—
- [x] æœ¬æ–‡æ¡£

---

## ğŸ¯ æ€»ç»“

Avatar ç³»ç»Ÿæ˜¯ä¸€ä¸ª**å®Œæ•´çš„ã€ç”Ÿäº§å°±ç»ªçš„**å¤´åƒç®¡ç†è§£å†³æ–¹æ¡ˆï¼š

1. **æ¸…æ™°çš„æ¶æ„**: å‰åç«¯åˆ†ç¦»ï¼Œæ¨¡å—åŒ–è®¾è®¡
2. **å®Œæ•´çš„æµç¨‹**: ä»åˆå§‹åŒ–åˆ°ä½¿ç”¨çš„å…¨æµç¨‹è¦†ç›–
3. **å¥å£®çš„å®ç°**: å®Œå–„çš„éªŒè¯ã€é”™è¯¯å¤„ç†ã€å®‰å…¨æœºåˆ¶
4. **å¯æ‰©å±•æ€§**: é¢„ç•™äº‘ç«¯åŒæ­¥ã€AI ç”Ÿæˆç­‰æ‰©å±•æ¥å£
5. **è‰¯å¥½çš„æ–‡æ¡£**: è¯¦ç»†çš„æ¶æ„è¯´æ˜å’Œä½¿ç”¨æŒ‡å—

**å…³é”®è·¯å¾„**:
```
gui_v2/src/assets/avatars/ (æºæ–‡ä»¶)
    â†“ (åˆå§‹åŒ–è„šæœ¬å¤åˆ¶)
{appdata_path}/avatars/system/ (è¿è¡Œæ—¶)
    â†“ (AvatarManager è¯»å–)
å‰ç«¯æ˜¾ç¤º â†’ ç”¨æˆ·é€‰æ‹© â†’ ä¿å­˜åˆ°æ•°æ®åº“
```
