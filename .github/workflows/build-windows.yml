name: Build Windows EXE

on:
  push:
    branches: [ gui-v2 ]
  pull_request:
    branches: [ gui-v2 ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Verify Node.js installation
      run: |
        node --version
        npm --version
        echo "Node.js installation verified"
        echo "NPM_PATH: $env:NPM_PATH"
        echo "PATH: $env:PATH"
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: windows-pip-3.11-${{ hashFiles('requirements*.txt') }}
        restore-keys: |
          windows-pip-3.11-
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-windows.txt
        pip install pyinstaller pywin32-ctypes
    
    - name: Install frontend dependencies
      run: |
        cd gui_v2
        npm install --legacy-peer-deps --verbose
    
    # - name: Build frontend
    #   run: |
    #     cd gui_v2
    #     npm run build
    
    - name: Install Inno Setup
      run: |
        $DownloadUrl = "https://files.jrsoftware.org/is/6/innosetup-6.2.2.exe"
        $DownloadPath = "$env:TEMP\innosetup-6.2.2.exe"
        
        Write-Host "ğŸ“¥ ä¸‹è½½ Inno Setup..."
        Invoke-WebRequest -Uri $DownloadUrl -OutFile $DownloadPath -UseBasicParsing
        
        Write-Host "ğŸ”¨ å®‰è£… Inno Setup..."
        Start-Process -FilePath $DownloadPath -ArgumentList "/SILENT", "/SUPPRESSMSGBOXES", "/NORESTART" -Wait
        
        Write-Host "âœ… Inno Setup å®‰è£…å®Œæˆ"
    
    - name: Create build directories
      run: |
        New-Item -ItemType Directory -Force -Path build, dist
    
    - name: Build Windows EXE
      run: |
        python build.py prod --force
      env:
        PYTHONPATH: ${{ github.workspace }}
    
    - name: Check build result
      run: |
        echo "=== æ„å»ºç»“æœæ£€æŸ¥ ==="
        ls -la dist/
        
        if (Test-Path "dist/ECBot.exe") {
          $exe = Get-Item "dist/ECBot.exe"
          echo "âœ… Windows EXE æ„å»ºæˆåŠŸ"
          echo "æ–‡ä»¶å¤§å°: $($exe.Length / 1MB) MB"
        } elseif (Test-Path "dist/ECBot/ECBot.exe") {
          $exe = Get-Item "dist/ECBot/ECBot.exe"
          echo "âœ… Windows EXE æ„å»ºæˆåŠŸ"
          echo "æ–‡ä»¶å¤§å°: $($exe.Length / 1MB) MB"
        } else {
          echo "âŒ Windows EXE æ„å»ºå¤±è´¥"
          exit 1
        }
        
        if (Test-Path "dist/ECBot-Setup.exe") {
          $setup = Get-Item "dist/ECBot-Setup.exe"
          echo "âœ… å®‰è£…åŒ…æ„å»ºæˆåŠŸ"
          echo "å®‰è£…åŒ…å¤§å°: $($setup.Length / 1MB) MB"
        }
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ECBot-Windows
        path: |
          dist/ECBot-Setup.exe
        retention-days: 30 