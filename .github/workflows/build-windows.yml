name: Build Windows EXE

on:
  # push:
  #   branches: [ gui-v2 ]
  # pull_request:
  #   branches: [ gui-v2 ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 45
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        # cache-dependency-path: gui_v2/package-lock.json
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: windows-pip-3.11-${{ hashFiles('requirements*.txt') }}
        restore-keys: |
          windows-pip-3.11-
    
    - name: Install Python dependencies
      run: |
        echo "=== Installing Python Dependencies ==="
        python -m pip install --upgrade pip
        pip install -r requirements-windows.txt
        pip install pyinstaller pywin32-ctypes
        
        echo "=== Verifying pywin32 installation ==="
        python -c "import win32api; print('pywin32 installed successfully')"
    
    - name: Install frontend dependencies
      run: |
        echo "=== Installing Frontend Dependencies ==="
        cd gui_v2
        npm ci --legacy-peer-deps
    
    - name: Install Inno Setup
      run: |
        echo "=== Installing Inno Setup ==="
        $DownloadUrl = "https://files.jrsoftware.org/is/6/innosetup-6.2.2.exe"
        $DownloadPath = "$env:TEMP\innosetup-6.2.2.exe"
        
        Write-Host "üì• Downloading Inno Setup..."
        Invoke-WebRequest -Uri $DownloadUrl -OutFile $DownloadPath -UseBasicParsing
        
        Write-Host "üî® Installing Inno Setup..."
        Start-Process -FilePath $DownloadPath -ArgumentList "/SILENT", "/SUPPRESSMSGBOXES", "/NORESTART" -Wait
        
        Write-Host "‚úÖ Inno Setup installation completed"
        
        # Verify installation
        $innoPath = "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe"
        if (Test-Path $innoPath) {
            Write-Host "‚úÖ Inno Setup verified at: $innoPath"
        } else {
            Write-Host "‚ùå Inno Setup not found at expected location"
            exit 1
        }
    
    - name: Create build directories
      run: |
        echo "=== Creating Build Directories ==="
        New-Item -ItemType Directory -Force -Path build, dist
    
    - name: Check build environment
      run: |
        echo "=== Checking Build Environment ==="
        python build.py --check-env
    
    - name: Build Windows EXE
      run: |
        echo "=== Starting Windows Build ==="
        echo "Command: python build.py prod --force"
        
        # Set environment variables
        $env:PYTHONPATH = "$PWD"
        $env:PYTHONUNBUFFERED = "1"
        
        # Run build with detailed output
        python build.py prod --force 2>&1 | Tee-Object -FilePath "build.log"
        
        # Check exit code
        if ($LASTEXITCODE -ne 0) {
            echo "‚ùå Build failed with exit code: $LASTEXITCODE"
            echo "=== Build Log ==="
            Get-Content "build.log"
            exit 1
        }
        
        echo "‚úÖ Build completed successfully"
    
    - name: Check build result
      run: |
        echo "=== Build Result Check ==="
        echo "Dist directory contents:"
        Get-ChildItem -Path "dist" -Recurse | Format-Table -AutoSize
        
        $exeFound = $false
        $setupFound = $false
        
        if (Test-Path "dist/ECBot/ECBot.exe") {
            $exe = Get-Item "dist/ECBot/ECBot.exe"
            echo "‚úÖ Windows EXE found: dist/ECBot/ECBot.exe"
            echo "   Size: $([math]::Round($exe.Length / 1MB, 2)) MB"
            echo "   Created: $($exe.CreationTime)"
            $exeFound = $true
        } else {
            echo "‚ùå Windows EXE not found"
            echo "Searching for .exe files..."
            Get-ChildItem -Path "dist" -Recurse -Filter "*.exe" | ForEach-Object {
                echo "   Found: $($_.FullName)"
            }
        }
        
        if (Test-Path "dist/ECBot-Setup.exe") {
            $setup = Get-Item "dist/ECBot-Setup.exe"
            echo "‚úÖ Installer found: dist/ECBot-Setup.exe"
            echo "   Size: $([math]::Round($setup.Length / 1MB, 2)) MB"
            echo "   Created: $($setup.CreationTime)"
            $setupFound = $true
        } else {
            echo "‚ö†Ô∏è  Installer not found"
        }
        
        if (-not $exeFound) {
            echo "‚ùå Build validation failed - no executable found"
            exit 1
        }
        
        echo "‚úÖ Build validation passed"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ECBot-Windows-Build
        path: |
          dist/
          build.log
        retention-days: 30
    
    - name: Upload installer artifact
      uses: actions/upload-artifact@v4
      if: hashFiles('dist/ECBot-Setup.exe') != ''
      with:
        name: ECBot-Windows-Installer
        path: dist/ECBot-Setup.exe
        retention-days: 30 