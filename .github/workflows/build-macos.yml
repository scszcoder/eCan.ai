name: Build macOS App

on:
  # push:
  #   branches: [ gui-v2 ]
  # pull_request:
  #   branches: [ gui-v2 ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    timeout-minutes: 45
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        # cache-dependency-path: gui_v2/package-lock.json
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: macos-pip-3.11-${{ hashFiles('requirements*.txt') }}
        restore-keys: |
          macos-pip-3.11-
    
    - name: Install Python dependencies
      run: |
        echo "=== Installing Python Dependencies ==="
        python -m pip install --upgrade pip
        pip install -r requirements-macos.txt
        pip install pyinstaller
        
        echo "=== Verifying PyInstaller installation ==="
        python -c "import PyInstaller; print('PyInstaller installed successfully')"
    
    - name: Install frontend dependencies
      run: |
        echo "=== Installing Frontend Dependencies ==="
        cd gui_v2
        npm ci --legacy-peer-deps
    
    - name: Create build directories
      run: |
        echo "=== Creating Build Directories ==="
        mkdir -p build dist
    
    - name: Check build environment
      run: |
        echo "=== Checking Build Environment ==="
        python build.py --check-env
    
    - name: Build macOS App
      run: |
        echo "=== Starting macOS Build ==="
        echo "Command: python build.py prod --force"
        
        # Set environment variables
        export PYTHONPATH="$PWD"
        export PYTHONUNBUFFERED=1
        
        # Run build with detailed output
        python build.py prod --force 2>&1 | tee build.log
        
        # Check exit code
        if [ $? -ne 0 ]; then
            echo "❌ Build failed"
            echo "=== Build Log ==="
            cat build.log
            exit 1
        fi
        
        echo "✅ Build completed successfully"
    
    - name: Check build result
      run: |
        echo "=== Build Result Check ==="
        echo "Dist directory contents:"
        ls -la dist/
        
        if [ -d "dist/ECBot.app" ]; then
            echo "✅ macOS App found: dist/ECBot.app"
            app_size=$(du -sh dist/ECBot.app | cut -f1)
            echo "   Size: $app_size"
            
            # Check app structure
            echo "   App structure:"
            find dist/ECBot.app -type f -name "ECBot" | head -5
        else
            echo "❌ macOS App not found"
            echo "Searching for .app files..."
            find dist -name "*.app" 2>/dev/null || echo "No .app files found"
            exit 1
        fi
        
        echo "✅ Build validation passed"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ECBot-macOS-Build
        path: |
          dist/
          build.log
        retention-days: 30 