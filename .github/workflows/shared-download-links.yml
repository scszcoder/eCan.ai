# ============================================================================
# Reusable Workflow: Download Links Generation
# ============================================================================
# This reusable workflow generates user-friendly download links for release
# artifacts hosted on AWS S3. It creates both GitHub Actions Summary output
# and a downloadable text file with all URLs.
#
# Features:
#   - Generates download links for Windows and macOS installers
#   - Provides both standard and accelerated S3 URLs
#   - Creates GitHub Actions Summary with formatted links
#   - Generates downloadable text file with all URLs
#   - Supports architecture detection and labeling
#
# Usage:
#   jobs:
#     links:
#       uses: ./.github/workflows/shared-download-links.yml
#       with:
#         version: ${{ needs.validate-tag.outputs.version }}
#       secrets: inherit
# ============================================================================

name: Shared Download Links Generation

on:
  workflow_call:
    inputs:
      version:
        description: 'Version string for the release'
        required: true
        type: string
      windows-build-result:
        description: 'Result of Windows build job (success/skipped/failure)'
        required: true
        type: string
      macos-build-result:
        description: 'Result of macOS build job (success/skipped/failure)'
        required: true
        type: string

jobs:
  generate-links:
    name: Generate Download Links
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID || 'NOT_SET' }}
      S3_BUCKET: ${{ secrets.S3_BUCKET || 'NOT_SET' }}
      S3_BASE_PATH: ${{ secrets.S3_BASE_PATH || 'NOT_SET' }}
      AWS_REGION: ${{ secrets.AWS_REGION || 'NOT_SET' }}
      VERSION: ${{ inputs.version }}

    steps:
      # ------------------------------------------------------------------------
      # Step Group 1: Download Artifacts
      # ------------------------------------------------------------------------
      - name: Download Windows artifacts
        if: inputs.windows-build-result == 'success' && env.AWS_ACCESS_KEY_ID != 'NOT_SET'
        uses: actions/download-artifact@v4
        with:
          name: eCan-windows-amd64-${{ inputs.version }}-s3-transfer
          path: windows-artifacts
        continue-on-error: true

      - name: Download macOS amd64 artifacts
        if: inputs.macos-build-result == 'success' && env.AWS_ACCESS_KEY_ID != 'NOT_SET'
        uses: actions/download-artifact@v4
        with:
          name: eCan-macos-amd64-${{ inputs.version }}-s3-transfer
          path: macos-amd64-artifacts
        continue-on-error: true

      - name: Download macOS aarch64 artifacts
        if: inputs.macos-build-result == 'success' && env.AWS_ACCESS_KEY_ID != 'NOT_SET'
        uses: actions/download-artifact@v4
        with:
          name: eCan-macos-aarch64-${{ inputs.version }}-s3-transfer
          path: macos-aarch64-artifacts
        continue-on-error: true

      - name: Merge macOS artifacts
        if: inputs.macos-build-result == 'success'
        run: |
          mkdir -p macos-artifacts
          for d in macos-amd64-artifacts macos-aarch64-artifacts; do
            if [ -d "$d" ]; then 
              cp "$d"/* macos-artifacts/ 2>/dev/null || true
            fi
          done

      # ------------------------------------------------------------------------
      # Step Group 2: Generate GitHub Actions Summary
      # ------------------------------------------------------------------------
      - name: Generate S3 download links summary
        if: env.AWS_ACCESS_KEY_ID != 'NOT_SET' && env.S3_BUCKET != 'NOT_SET' && env.S3_BASE_PATH != 'NOT_SET'
        env:
          # Use non-secret variables to avoid masking in output
          BUCKET_NAME: ${{ secrets.S3_BUCKET || 'NOT_SET' }}
          BUCKET_REGION: ${{ secrets.AWS_REGION || 'NOT_SET' }}
          BUCKET_BASE_PATH: ${{ secrets.S3_BASE_PATH || 'NOT_SET' }}
        run: |
          echo "=== Generating S3 Download Links ==="
          echo ""
          
          # Display in GitHub Actions Summary
          echo "## ðŸ“¦ Download Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Version: **${VERSION}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Windows Installers
          echo "### Windows Installers (x86_64)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "windows-artifacts" ] && [ "$(ls -A windows-artifacts 2>/dev/null)" ]; then
            for file in windows-artifacts/*.exe windows-artifacts/*.msi; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                size=$(du -sh "$file" | cut -f1)
                
                # Standard S3 URL
                standard_url="https://${BUCKET_NAME}.s3.${BUCKET_REGION}.amazonaws.com/${BUCKET_BASE_PATH}/v${VERSION}/windows/${filename}"
                
                # S3 Transfer Acceleration URL
                accelerate_url="https://${BUCKET_NAME}.s3-accelerate.amazonaws.com/${BUCKET_BASE_PATH}/v${VERSION}/windows/${filename}"
                
                echo "#### ${filename}" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "- **Size**: ${size}" >> $GITHUB_STEP_SUMMARY
                echo "- **Standard URL**: [Download](${standard_url})" >> $GITHUB_STEP_SUMMARY
                echo "  \`\`\`" >> $GITHUB_STEP_SUMMARY
                echo "  ${standard_url}" >> $GITHUB_STEP_SUMMARY
                echo "  \`\`\`" >> $GITHUB_STEP_SUMMARY
                echo "- **Accelerated URL** (faster for global users): [Download](${accelerate_url})" >> $GITHUB_STEP_SUMMARY
                echo "  \`\`\`" >> $GITHUB_STEP_SUMMARY
                echo "  ${accelerate_url}" >> $GITHUB_STEP_SUMMARY
                echo "  \`\`\`" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "_No Windows installers available_" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # macOS Installers
          echo "### macOS Installers" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "macos-artifacts" ] && [ "$(ls -A macos-artifacts 2>/dev/null)" ]; then
            for file in macos-artifacts/*.pkg macos-artifacts/*.zip; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                size=$(du -sh "$file" | cut -f1)
                
                # Determine architecture from filename
                if [[ "$filename" == *"amd64"* ]] || [[ "$filename" == *"x86_64"* ]]; then
                  arch_label="Intel (x86_64)"
                elif [[ "$filename" == *"aarch64"* ]] || [[ "$filename" == *"arm64"* ]]; then
                  arch_label="Apple Silicon (ARM64)"
                else
                  arch_label="Universal"
                fi
                
                # Standard S3 URL
                standard_url="https://${BUCKET_NAME}.s3.${BUCKET_REGION}.amazonaws.com/${BUCKET_BASE_PATH}/v${VERSION}/macos/${filename}"
                
                # S3 Transfer Acceleration URL
                accelerate_url="https://${BUCKET_NAME}.s3-accelerate.amazonaws.com/${BUCKET_BASE_PATH}/v${VERSION}/macos/${filename}"
                
                echo "#### ${filename}" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "- **Architecture**: ${arch_label}" >> $GITHUB_STEP_SUMMARY
                echo "- **Size**: ${size}" >> $GITHUB_STEP_SUMMARY
                echo "- **Standard URL**: [Download](${standard_url})" >> $GITHUB_STEP_SUMMARY
                echo "  \`\`\`" >> $GITHUB_STEP_SUMMARY
                echo "  ${standard_url}" >> $GITHUB_STEP_SUMMARY
                echo "  \`\`\`" >> $GITHUB_STEP_SUMMARY
                echo "- **Accelerated URL** (faster for global users): [Download](${accelerate_url})" >> $GITHUB_STEP_SUMMARY
                echo "  \`\`\`" >> $GITHUB_STEP_SUMMARY
                echo "  ${accelerate_url}" >> $GITHUB_STEP_SUMMARY
                echo "  \`\`\`" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "_No macOS installers available_" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Documentation section
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Download Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### URL Types" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Standard URL**: Direct S3 access from the bucket's region" >> $GITHUB_STEP_SUMMARY
          echo "  - Best for: Users in the same AWS region" >> $GITHUB_STEP_SUMMARY
          echo "  - Format: \`https://{bucket}.s3.{region}.amazonaws.com/{path}/{file}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Accelerated URL**: Uses AWS S3 Transfer Acceleration" >> $GITHUB_STEP_SUMMARY
          echo "  - Best for: Global users, faster downloads worldwide" >> $GITHUB_STEP_SUMMARY
          echo "  - Format: \`https://{bucket}.s3-accelerate.amazonaws.com/{path}/{file}\`" >> $GITHUB_STEP_SUMMARY
          echo "  - Requires: Transfer Acceleration enabled on S3 bucket" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Platform Support" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Windows**: x86_64 (64-bit) only" >> $GITHUB_STEP_SUMMARY
          echo "  - \`.exe\`: Inno Setup installer (recommended)" >> $GITHUB_STEP_SUMMARY
          echo "  - \`.msi\`: Windows Installer package" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **macOS**: Intel and Apple Silicon" >> $GITHUB_STEP_SUMMARY
          echo "  - \`amd64\`: Intel processors (x86_64)" >> $GITHUB_STEP_SUMMARY
          echo "  - \`aarch64\`: Apple Silicon (M1/M2/M3)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      # ------------------------------------------------------------------------
      # Step Group 3: Generate Text File
      # ------------------------------------------------------------------------
      - name: Generate download links text artifact
        if: env.AWS_ACCESS_KEY_ID != 'NOT_SET' && env.S3_BUCKET != 'NOT_SET' && env.S3_BASE_PATH != 'NOT_SET'
        env:
          BUCKET_NAME: ${{ secrets.S3_BUCKET || 'NOT_SET' }}
          BUCKET_REGION: ${{ secrets.AWS_REGION || 'NOT_SET' }}
          BUCKET_BASE_PATH: ${{ secrets.S3_BASE_PATH || 'NOT_SET' }}
        run: |
          set -euo pipefail
          OUTPUT_FILE="download-links-${VERSION}.txt"

          echo "eCan Download Links" > "$OUTPUT_FILE"
          echo "" >> "$OUTPUT_FILE"
          echo "Version: ${VERSION}" >> "$OUTPUT_FILE"
          echo "" >> "$OUTPUT_FILE"

          # Windows section
          if [ -d "windows-artifacts" ] && [ "$(ls -A windows-artifacts 2>/dev/null)" ]; then
            echo "[Windows]" >> "$OUTPUT_FILE"
            echo "" >> "$OUTPUT_FILE"

            for file in windows-artifacts/*.exe windows-artifacts/*.msi; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                size=$(du -sh "$file" | cut -f1)
                standard_url="https://${BUCKET_NAME}.s3.${BUCKET_REGION}.amazonaws.com/${BUCKET_BASE_PATH}/v${VERSION}/windows/${filename}"
                accelerate_url="https://${BUCKET_NAME}.s3-accelerate.amazonaws.com/${BUCKET_BASE_PATH}/v${VERSION}/windows/${filename}"

                echo "${filename}" >> "$OUTPUT_FILE"
                echo "  Size:       ${size}" >> "$OUTPUT_FILE"
                echo "  Standard:   ${standard_url}" >> "$OUTPUT_FILE"
                echo "  Accelerate: ${accelerate_url}" >> "$OUTPUT_FILE"
                echo "" >> "$OUTPUT_FILE"
              fi
            done
            echo "" >> "$OUTPUT_FILE"
          else
            echo "[Windows]" >> "$OUTPUT_FILE"
            echo "  No Windows installers available" >> "$OUTPUT_FILE"
            echo "" >> "$OUTPUT_FILE"
          fi

          # macOS section
          if [ -d "macos-artifacts" ] && [ "$(ls -A macos-artifacts 2>/dev/null)" ]; then
            echo "[macOS]" >> "$OUTPUT_FILE"
            echo "" >> "$OUTPUT_FILE"

            for file in macos-artifacts/*.pkg macos-artifacts/*.zip; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                size=$(du -sh "$file" | cut -f1)
                if [[ "$filename" == *"amd64"* ]] || [[ "$filename" == *"x86_64"* ]]; then
                  arch_label="Intel (x86_64)"
                elif [[ "$filename" == *"aarch64"* ]] || [[ "$filename" == *"arm64"* ]]; then
                  arch_label="Apple Silicon (ARM64)"
                else
                  arch_label="Universal"
                fi

                standard_url="https://${BUCKET_NAME}.s3.${BUCKET_REGION}.amazonaws.com/${BUCKET_BASE_PATH}/v${VERSION}/macos/${filename}"
                accelerate_url="https://${BUCKET_NAME}.s3-accelerate.amazonaws.com/${BUCKET_BASE_PATH}/v${VERSION}/macos/${filename}"

                echo "${filename}" >> "$OUTPUT_FILE"
                echo "  Arch:       ${arch_label}" >> "$OUTPUT_FILE"
                echo "  Size:       ${size}" >> "$OUTPUT_FILE"
                echo "  Standard:   ${standard_url}" >> "$OUTPUT_FILE"
                echo "  Accelerate: ${accelerate_url}" >> "$OUTPUT_FILE"
                echo "" >> "$OUTPUT_FILE"
              fi
            done
            echo "" >> "$OUTPUT_FILE"
          else
            echo "[macOS]" >> "$OUTPUT_FILE"
            echo "  No macOS installers available" >> "$OUTPUT_FILE"
            echo "" >> "$OUTPUT_FILE"
          fi

          echo "---" >> "$OUTPUT_FILE"
          echo "This file contains all download URLs for this build." >> "$OUTPUT_FILE"
          echo "Generated by the release workflow at $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> "$OUTPUT_FILE"

          echo "Download links document generated: ${OUTPUT_FILE}"

      - name: Upload download links document artifact
        if: env.AWS_ACCESS_KEY_ID != 'NOT_SET' && env.S3_BUCKET != 'NOT_SET' && env.S3_BASE_PATH != 'NOT_SET'
        uses: actions/upload-artifact@v4
        with:
          name: download-links-${{ inputs.version }}
          path: download-links-${{ inputs.version }}.txt
          if-no-files-found: warn
