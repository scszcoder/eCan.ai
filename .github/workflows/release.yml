name: Release Build eCan
#
# é€šè¿‡ workflow_dispatch å‚æ•° platform/arch å¯é€‰æ‹©æ‰“åŒ…å¹³å°å’Œ CPU æž¶æž„ï¼š
#   - platform: windows, macos, all
#   - arch: x86_64, arm64
#
# æ³¨æ„ï¼š
#   - Windows ä»…æ”¯æŒ x86_64 æž¶æž„ï¼ˆGitHub Actions æ—  ARM runnerï¼‰
#   - macOS æ”¯æŒ x86_64/arm64ï¼Œä½† GitHub Actions runner é»˜è®¤æ˜¯ x86_64ï¼Œarm64 éœ€æœ¬åœ° M1/M2/M3 Mac æˆ–ä¸“ç”¨ runner
#
# ç¤ºä¾‹ï¼š
#   - æ‰‹åŠ¨è§¦å‘ workflow æ—¶å¯é€‰æ‹©å¹³å°å’Œæž¶æž„
#   - æŽ¨é€ tag æˆ–å‘å¸ƒ release æ—¶è‡ªåŠ¨è§¦å‘ï¼Œé»˜è®¤æ‰“åŒ… all + x86_64

on:
  # Trigger conditions: create tag or release
  # push:
  #   tags:
  #     - 'v*'  # Match formats like v1.0.0, v2.1.3
  release:
    types: [published, edited, created]
  # Manual trigger
  workflow_dispatch:
    inputs:
      platform:
        description: 'Build platform (windows, macos, all)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - windows
          - macos
      arch:
        description: 'CPU architecture (macOS: x86_64/arm64, Windows: x86_64 only)'
        required: true
        default: 'x86_64'
        type: choice
        options:
          - x86_64
          - arm64
      tag:
        description: 'Git tag to build (e.g. v1.2.3)'
        required: true
        default: ''
        type: string

jobs:
  # Validate tag format
  validate-tag:
    runs-on: ubuntu-latest
    outputs:
      tag-valid: ${{ steps.validate.outputs.valid }}
      version: ${{ steps.validate.outputs.version }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.tag || github.ref }}
      
    - name: Validate tag format
      id: validate
      run: |
        TAG_NAME="${{ github.event.inputs.tag }}"
        if [ -z "$TAG_NAME" ]; then
          TAG_NAME="${GITHUB_REF#refs/tags/}"
        fi
        if [[ "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$ ]]; then
          echo "valid=true" >> $GITHUB_OUTPUT
          echo "version=${TAG_NAME#v}" >> $GITHUB_OUTPUT
          echo "âœ… Valid tag format: $TAG_NAME"
        else
          echo "valid=false" >> $GITHUB_OUTPUT
          echo "âŒ Invalid tag format: $TAG_NAME"
          echo "Expected format: vX.Y.Z or vX.Y.Z-prerelease"
          exit 1
        fi

  # Windows build
  # æ³¨æ„ï¼šGitHub Actions ç›®å‰ä»…æ”¯æŒ Windows x86_64 æž¶æž„ï¼ŒWindows ARM æž¶æž„æš‚ä¸æ”¯æŒ
  build-windows:
    needs: validate-tag
    if: |
      needs.validate-tag.outputs.tag-valid == 'true' && 
      (github.event.inputs.platform == 'windows' || 
       github.event.inputs.platform == 'all' || 
       github.event.inputs.platform == null) &&
      (github.event.inputs.arch == 'x86_64' || github.event.inputs.arch == null)
    runs-on: windows-latest
    timeout-minutes: 45
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: windows-pip-3.11-${{ hashFiles('requirements*.txt') }}
        restore-keys: |
          windows-pip-3.11-
    
    - name: Create and activate venv (Windows)
      run: |
        echo "=== Creating Virtual Environment ==="
        python -m venv .venv
        # Make venv's Python first in PATH for subsequent steps
        echo "$PWD\.venv\Scripts" >> $env:GITHUB_PATH
    
    - name: Install Python dependencies
      run: |
        echo "=== Python/Pip Info (Windows venv) ==="
        python -c "import sys; print(sys.version); print(sys.executable)"
        python -m pip -V

        echo "=== Installing Python Dependencies ==="
        python -m pip install --upgrade pip
        python -m pip install -r requirements-windows.txt
        python -m pip install pyinstaller pywin32-ctypes
        # Ensure pywin32 is present in the same interpreter
        python -m pip install -U pywin32
        # Rarely needed but safe; registers COM bits
        python -m pywin32_postinstall -install

        echo "=== Verifying pywin32 installation ==="
        python -c "import win32api; print('pywin32 installed successfully')"
    
    - name: Uninstall pathlib if present (Windows)
      run: |
        python -m pip uninstall -y pathlib; if ($LASTEXITCODE -ne 0) { Write-Host "pathlib not found or already uninstalled" }
    
    - name: Install frontend dependencies
      run: |
        echo "=== Installing Frontend Dependencies ==="
        cd gui_v2
        npm install --legacy-peer-deps
    
    - name: Install Inno Setup
      run: |
        echo "=== Installing Inno Setup ==="
        $DownloadUrl = "https://files.jrsoftware.org/is/6/innosetup-6.2.2.exe"
        $DownloadPath = "$env:TEMP\innosetup-6.2.2.exe"
        
        Write-Host "ðŸ“¥ Downloading Inno Setup..."
        Invoke-WebRequest -Uri $DownloadUrl -OutFile $DownloadPath -UseBasicParsing
        
        Write-Host "ðŸ”¨ Installing Inno Setup..."
        Start-Process -FilePath $DownloadPath -ArgumentList "/SILENT", "/SUPPRESSMSGBOXES", "/NORESTART" -Wait
        
        Write-Host "âœ… Inno Setup installation completed"
        
        # Verify installation
        $innoPath = "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe"
        if (Test-Path $innoPath) {
            Write-Host "âœ… Inno Setup verified at: $innoPath"
        } else {
            Write-Host "âŒ Inno Setup not found at expected location"
            exit 1
        }
    
    - name: Install OTA dependencies (including winSparkle)
      run: |
        echo "=== Installing OTA Dependencies ==="
        python scripts/install_ota_dependencies.py install --platform windows
        
        echo "=== Verifying OTA Dependencies ==="
        python scripts/install_ota_dependencies.py verify
        
        echo "=== Checking winSparkle Installation ==="
        $dllPaths = @(
          "ota/dependencies/lib/winsparkle.dll",
          "ota/dependencies/winsparkle/winsparkle.dll"
        )
        $found = $false
        foreach ($p in $dllPaths) {
          if (Test-Path $p) {
            Write-Host "âœ… winSparkle DLL found at: $p"
            $dll = Get-Item $p
            Write-Host "   Size: $([math]::Round($dll.Length / 1KB, 2)) KB"
            $found = $true
            break
          }
        }
        if (-not $found) {
          Write-Host "[WARN] winSparkle DLL not found in expected locations"
          Write-Host "Searching for winSparkle files..."
          Get-ChildItem -Path "ota" -Recurse -Filter "*sparkle*" | ForEach-Object {
            Write-Host "   Found: $($_.FullName)"
          }
        }

    - name: Create build directories
      run: |
        echo "=== Creating Build Directories ==="
        New-Item -ItemType Directory -Force -Path build, dist
    
    - name: Check build environment
      run: |
        echo "=== Checking Build Environment ==="
        python scripts/check_build_env.py
    
    - name: Build Windows EXE
      run: |
        echo "=== Starting Windows Build ==="
        echo "Command: python build.py prod --force"
        
        # Set environment variables
        $env:PYTHONPATH = "$PWD"
        $env:PYTHONUNBUFFERED = "1"
        
        # Run build with detailed output (including Sparkle support)
        python build.py prod --force --version ${{ needs.validate-tag.outputs.version }} --enable-sparkle --verify-sparkle 2>&1 | Tee-Object -FilePath "build.log"
        
        # é‡å‘½åäº§ç‰©ï¼Œè§„èŒƒä¸º eCan-windows-x86_64-v{version}.exe
        if (Test-Path "dist/eCan/eCan.exe") {
          Rename-Item "dist/eCan/eCan.exe" "dist/eCan-windows-x86_64-v${{ needs.validate-tag.outputs.version }}.exe"
        }
        if (Test-Path "dist/eCan-Setup.exe") {
          Rename-Item "dist/eCan-Setup.exe" "dist/eCan-Setup-windows-x86_64-v${{ needs.validate-tag.outputs.version }}.exe"
        }
        
        # Check exit code
        if ($LASTEXITCODE -ne 0) {
            echo "[ERROR] Build failed with exit code: $LASTEXITCODE"
            echo "=== Build Log ==="
            Get-Content "build.log"
            exit 1
        }
        
        echo "[OK] Build completed successfully"

        echo "=== Verifying OTA artifacts in dist ==="
        $distWinSparkle = @(
          "dist/eCan/ota/dependencies/lib/winsparkle.dll",
          "dist/ota/dependencies/lib/winsparkle.dll"
        )
        $distFound = $false
        foreach ($p in $distWinSparkle) {
          if (Test-Path $p) {
            Write-Host "[OK] winSparkle DLL packaged at: $p"
            $dll = Get-Item $p
            Write-Host "   Size: $([math]::Round($dll.Length / 1KB, 2)) KB"
            $distFound = $true
            break
          }
        }
        if (-not $distFound) {
          Write-Host "[WARN] winSparkle DLL not found in dist; OTA (Windows) may be disabled"
        }

    - name: Check build result
      run: |
        echo "=== Build Result Check ==="
        echo "Dist directory contents:"
        Get-ChildItem -Path "dist" -Recurse | Format-Table -AutoSize
        
        $exeFound = $false
        $setupFound = $false
        
        if (Test-Path "dist/eCan/eCan.exe") {
            $exe = Get-Item "dist/eCan/eCan.exe"
            echo "âœ… Windows EXE found: dist/eCan/eCan.exe"
            echo "   Size: $([math]::Round($exe.Length / 1MB, 2)) MB"
            echo "   Created: $($exe.CreationTime)"
            $exeFound = $true
        } else {
            echo "âŒ Windows EXE not found"
            echo "Searching for .exe files..."
            Get-ChildItem -Path "dist" -Recurse -Filter "*.exe" | ForEach-Object {
                echo "   Found: $($_.FullName)"
            }
        }
        
        if (Test-Path "dist/eCan-Setup.exe") {
            $setup = Get-Item "dist/eCan-Setup.exe"
            echo "âœ… Installer found: dist/eCan-Setup.exe"
            echo "   Size: $([math]::Round($setup.Length / 1MB, 2)) MB"
            echo "   Created: $($setup.CreationTime)"
            $setupFound = $true
        } else {
            echo "âš ï¸  Installer not found"
        }
        
        if (-not $exeFound) {
            echo "âŒ Build validation failed - no executable found"
            exit 1
        }
        
        echo "âœ… Build validation passed"
    
    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: eCan-Windows-${{ needs.validate-tag.outputs.version }}
        path: |
          dist/eCan-windows-x86_64-v${{ needs.validate-tag.outputs.version }}.exe
          dist/eCan-Setup-windows-x86_64-v${{ needs.validate-tag.outputs.version }}.exe
          build.log
        retention-days: 30

  # macOS build
  build-macos:
    needs: validate-tag
    if: |
      needs.validate-tag.outputs.tag-valid == 'true' && 
      (github.event.inputs.platform == 'macos' || 
       github.event.inputs.platform == 'all' || 
       github.event.inputs.platform == null)
    runs-on: macos-latest
    timeout-minutes: 45
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: macos-pip-3.11-${{ hashFiles('requirements*.txt') }}
        restore-keys: |
          macos-pip-3.11-
    
    - name: Create and activate venv (macOS)
      run: |
        echo "=== Creating Virtual Environment ==="
        python -m venv .venv
        # Make venv's Python first in PATH for subsequent steps
        echo "$PWD/.venv/bin" >> $GITHUB_PATH
    
    - name: Install Python dependencies
      run: |
        echo "=== Python/Pip Info (macOS venv) ==="
        python -c "import sys; print(sys.version); print(sys.executable)"
        python -m pip -V

        echo "=== Installing Python Dependencies ==="
        python -m pip install --upgrade pip
        python -m pip install -r requirements-macos.txt
        python -m pip install pyinstaller
        
        echo "=== Verifying PyInstaller installation ==="
        python -c "import PyInstaller; print('PyInstaller installed successfully')"
    
    - name: Uninstall pathlib if present (macOS)
      run: |
        python -m pip uninstall -y pathlib || true
    
    - name: Install frontend dependencies
      run: |
        echo "=== Installing Frontend Dependencies ==="
        cd gui_v2
        npm ci --legacy-peer-deps
    
    - name: Install OTA dependencies (including Sparkle)
      run: |
        echo "=== Installing OTA Dependencies ==="
        python scripts/install_ota_dependencies.py install --platform darwin
        
        echo "=== Verifying OTA Dependencies ==="
        python scripts/install_ota_dependencies.py verify
        
        echo "=== Checking Sparkle Framework Installation ==="
        if [ -d "ota/dependencies/Sparkle.framework" ]; then
          echo "âœ… Sparkle.framework found"
          framework_size=$(du -sh ota/dependencies/Sparkle.framework | cut -f1)
          echo "   Size: $framework_size"
          
          # Check framework structure
          if [ -f "ota/dependencies/Sparkle.framework/Versions/Current/Sparkle" ]; then
            echo "âœ… Sparkle binary found in framework"
          else
            echo "âš ï¸  Sparkle binary not found in expected location"
          fi
          
          if [ -f "ota/dependencies/Sparkle.framework/Versions/Current/Resources/sparkle-cli" ]; then
            echo "[OK] Sparkle CLI found"
          else
            echo "[WARN] Sparkle CLI not found"
          fi
        else
          echo "[ERROR] Sparkle.framework not found"
          echo "Searching for Sparkle files..."
          find ota -name "*parkle*" -type f 2>/dev/null || echo "No Sparkle files found"
        fi
    
    - name: Create build directories
      run: |
        echo "=== Creating Build Directories ==="
        mkdir -p build dist
    
    - name: Check build environment
      run: |
        echo "=== Checking Build Environment ==="
        python scripts/check_build_env.py
    
    - name: Build macOS App
      run: |
        echo "=== Starting macOS Build ==="
        echo "Command: python build.py prod --force"
        
        # Set environment variables
        export PYTHONPATH="$PWD"
        export PYTHONUNBUFFERED=1
        
        # Run build with detailed output (including Sparkle support)
        python build.py prod --force --version ${{ needs.validate-tag.outputs.version }} --enable-sparkle --verify-sparkle 2>&1 | tee build.log
        
        # è§„èŒƒäº§ç‰©å‘½åï¼ˆé€‚é…æ–°ç‰ˆ InstallerBuilder è¾“å‡º eCan-${{ needs.validate-tag.outputs.version }}.pkgï¼‰
        if [ -f "dist/eCan-${{ needs.validate-tag.outputs.version }}.pkg" ]; then
          mv "dist/eCan-${{ needs.validate-tag.outputs.version }}.pkg" "dist/eCan-macos-${{ github.event.inputs.arch || 'x86_64' }}-v${{ needs.validate-tag.outputs.version }}.pkg"
        fi
        if [ -d "dist/eCan.app" ]; then
          ditto -c -k --sequesterRsrc --keepParent "dist/eCan.app" "dist/eCan-macos-${{ github.event.inputs.arch || 'x86_64' }}-v${{ needs.validate-tag.outputs.version }}.zip"
        fi

        # Check exit code
        if [ $? -ne 0 ]; then
            echo "âŒ Build failed"
            echo "=== Build Log ==="
            cat build.log
            exit 1
        fi
        
        echo "âœ… Build completed successfully"
    
    - name: Check build result
      run: |
        echo "=== Build Result Check ==="
        echo "Dist directory contents:"
        ls -la dist/
        
        # Check for .pkg installer
        if [ -f "dist/eCan-${{ needs.validate-tag.outputs.version }}.pkg" ]; then
            echo "âœ… macOS PKG installer found: dist/eCan-${{ needs.validate-tag.outputs.version }}.pkg"
            pkg_size=$(du -sh dist/eCan-${{ needs.validate-tag.outputs.version }}.pkg | cut -f1)
            echo "   Size: $pkg_size"
        elif [ -d "dist/eCan.app" ]; then
            echo "âœ… macOS App found: dist/eCan.app"
            app_size=$(du -sh dist/eCan.app | cut -f1)
            echo "   Size: $app_size"

            # Check app structure
            echo "   App structure:"
            find dist/eCan.app -type f -name "eCan" | head -5
        else
            echo "âŒ macOS build not found"
            echo "Searching for .pkg and .app files..."
            find dist -name "*.pkg" 2>/dev/null || echo "No .pkg files found"
            find dist -name "*.app" 2>/dev/null || echo "No .app files found"
            exit 1
        fi
        
        echo "âœ… Build validation passed"
    
    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: eCan-macOS-${{ needs.validate-tag.outputs.version }}
        path: |
          dist/eCan-macos-*-v${{ needs.validate-tag.outputs.version }}.pkg
          dist/eCan-macos-*-v${{ needs.validate-tag.outputs.version }}.zip
          build.log
        retention-days: 30

  # Create Release
  create-release:
    needs: [validate-tag, build-windows, build-macos]
    if: |
      needs.validate-tag.outputs.tag-valid == 'true' && 
      startsWith(github.ref, 'refs/tags/v') &&
      (
        (github.event.inputs.platform == 'windows' && needs.build-windows.result == 'success') ||
        (github.event.inputs.platform == 'macos' && needs.build-macos.result == 'success') ||
        (github.event.inputs.platform == 'all' && needs.build-windows.result == 'success' && needs.build-macos.result == 'success') ||
        (github.event.inputs.platform == null && needs.build-windows.result == 'success' && needs.build-macos.result == 'success')
      )
    runs-on: ubuntu-latest
    
    steps:
    - name: Download Windows artifacts
      if: |
        github.event.inputs.platform == 'windows' || 
        github.event.inputs.platform == 'all' || 
        github.event.inputs.platform == null
      uses: actions/download-artifact@v4
      with:
        name: eCan-Windows-${{ needs.validate-tag.outputs.version }}
        path: windows-artifacts
    
    - name: Download macOS artifacts
      if: |
        github.event.inputs.platform == 'macos' || 
        github.event.inputs.platform == 'all' || 
        github.event.inputs.platform == null
      uses: actions/download-artifact@v4
      with:
        name: eCan-macOS-${{ needs.validate-tag.outputs.version }}
        path: macos-artifacts
    
    - name: Prepare release files list
      id: prep_files
      run: |
        echo "Listing downloaded artifacts..."
        ls -la windows-artifacts || true
        ls -la macos-artifacts || true
        echo "files<<EOF" >> $GITHUB_OUTPUT
        if ls windows-artifacts/*.exe 1> /dev/null 2>&1; then
          for f in windows-artifacts/*.exe; do echo "$f" >> $GITHUB_OUTPUT; done
        fi
        if ls macos-artifacts/*.pkg 1> /dev/null 2>&1; then
          for f in macos-artifacts/*.pkg; do echo "$f" >> $GITHUB_OUTPUT; done
        fi
        if ls macos-artifacts/*.zip 1> /dev/null 2>&1; then
          for f in macos-artifacts/*.zip; do echo "$f" >> $GITHUB_OUTPUT; done
        fi
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ steps.prep_files.outputs.files }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}